<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test Courbe de Ritaline</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Test Courbe de Ritaline</h1>
  <canvas id="ritalineChart" width="800" height="400"></canvas>

  <script>
    const ctx = document.getElementById('ritalineChart').getContext('2d');
    let chart;

    function calculerCourbe(doses) {
      // Crée un tableau d’heures toutes les 15 minutes de 6h à 22h
      const labels = [];
      const data = [];

      for (let h = 6; h <= 22; h++) {
        for (let m = 0; m < 60; m += 15) {
          labels.push(`${h}h${m.toString().padStart(2, '0')}`);
          data.push(0);
        }
      }

      // Ajoute chaque dose
      doses.forEach(d => {
        const dose = parseFloat(d.dose); // ⚠️ conversion en nombre
        const heureParts = d.heure.split('h');
        const heure = parseInt(heureParts[0]);
        const minute = parseInt(heureParts[1]);

        const startIndex = ((heure - 6) * 4) + Math.floor(minute / 15);
        if (startIndex >= 0 && startIndex < data.length) {
          for (let i = 0; i < 20 && startIndex + i < data.length; i++) {
            const t = i / 4;
            const concentration = dose * (t / 2) * Math.exp(1 - t / 2);
            data[startIndex + i] += concentration;
          }
        }
      });

      return { labels, data };
    }

    function updateChart(labels, data) {
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Concentration de Ritaline (mg)',
            data: data,
            borderColor: 'blue',
            borderWidth: 3,
            fill: false
          }]
        },
        options: {
          scales: {
            y: {
              title: {
                display: true,
                text: 'mg dans le corps'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Heure'
              }
            }
          }
        }
      });
    }

    window.addEventListener('message', (event) => {
      console.log("💥 JSON brut reçu :", event.data);

      try {
        const doses = JSON.parse(event.data);
        console.log("🧪 Données parsées :", doses);

        const { labels, data } = calculerCourbe(doses);
        updateChart(labels, data);
      } catch (error) {
        console.error("❌ Erreur de parsing JSON :", error);
      }
    }, false);
  </script>
</body>
</html>
