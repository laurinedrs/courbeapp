<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Test Courbe de Ritaline</title>
  <style>
    body {
      margin: 0;
      padding: 1rem;
      font-family: sans-serif;
    }
    canvas {
      width: 100% !important;
      max-width: 800px;
      height: 400px !important;
    }
  </style>
</head>
<body>
  <h1>Test Courbe de Ritaline</h1>
  <canvas id="ritalineChart"></canvas>

  <script>
    const canvas = document.getElementById('ritalineChart');
    const ctx = canvas.getContext('2d');

    function concentrationRitalineLP(t, dose) {
      const LI = dose * 0.5;
      const LP = dose * 0.5;

      const C_LI = LI * Math.exp(-1.2 * t);
      const delay = 3;
      const tLP = Math.max(t - delay, 0);
      const C_LP = LP * (tLP / 2) * Math.exp(-0.3 * tLP);

      return C_LI + C_LP;
    }

    function createChart(doses) {
      const heures = [];
      for (let h = 6; h <= 22; h += 0.25) {
        heures.push(h.toFixed(2));
      }

      const concentrations = heures.map(h => {
        const t = parseFloat(h);
        let total = 0;
        doses.forEach(entry => {
          if (!entry.heure || !entry.dose) return;

          const [hStr, mStr] = entry.heure.split(":");
          const heurePrise = parseInt(hStr) + parseInt(mStr) / 60;
          const delta = t - heurePrise;
          if (delta >= 0 && delta <= 12) {
            const doseNum = typeof entry.dose === "string" ? parseFloat(entry.dose) : entry.dose;
            total += concentrationRitalineLP(delta, doseNum);
          }
        });
        return total.toFixed(2);
      });

      const labels = heures.map(h => {
        const heure = Math.floor(h);
        const minutes = Math.round((h - heure) * 60);
        return `${heure}h${minutes.toString().padStart(2, '0')}`;
      });

      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Concentration de Ritaline (mg)',
            data: concentrations,
            borderColor: 'blue',
            backgroundColor: 'transparent',
            fill: false,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'mg dans le corps'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Heure'
              },
              ticks: {
                maxRotation: 90,
                minRotation: 60
              }
            }
          }
        }
      });
    }

    // ðŸ”½ THUNKABLE INJECTION ICI
    const urlParams = new URLSearchParams(window.location.search);
    const dataParam = urlParams.get('data');

    let doses = [];
    try {
      if (dataParam) {
        doses = JSON.parse(dataParam);
        console.log("âœ… DonnÃ©es reÃ§ues :", doses);
      }
    } catch (e) {
      console.error("Erreur de parsing JSON :", e);
    }

    createChart(doses);
  </script>
</body>
</html>
