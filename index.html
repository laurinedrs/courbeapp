<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test Courbe de Ritaline</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      padding: 1rem;
      font-family: sans-serif;
    }
    canvas {
      width: 100% !important;
      max-width: 800px;
      height: 400px !important;
    }
  </style>
</head>
<body>
  <h1>Test Courbe de Ritaline</h1>
  <canvas id="ritalineChart"></canvas>

  <script>
    const ctx = document.getElementById('ritalineChart').getContext('2d');

    function concentrationRitalineLP(t, dose) {
      const LI = dose * 0.5;
      const LP = dose * 0.5;

      const C_LI = LI * Math.exp(-1.2 * t);
      const delay = 3;
      const tLP = Math.max(t - delay, 0);
      const C_LP = LP * (tLP / 2) * Math.exp(-0.3 * tLP);

      return C_LI + C_LP;
    }

    function createChart(doses) {
      const heures = [];
      for (let h = 6; h <= 22; h += 0.25) {
        heures.push(h.toFixed(2));
      }

      const concentrations = heures.map(h => {
        const t = parseFloat(h);
        let total = 0;
        doses.forEach(({ heure, dose }) => {
          const [hStr, mStr] = heure.split(":");
          const heurePrise = parseInt(hStr) + parseInt(mStr) / 60;
          const delta = t - heurePrise;
          if (delta >= 0 && delta <= 12) {
            total += concentrationRitalineLP(delta, parseFloat(dose));
          }
        });
        return total.toFixed(2);
      });

      const labels = heures.map(h => {
        const heure = Math.floor(h);
        const minutes = Math.round((h - heure) * 60);
        return `${heure}h${minutes.toString().padStart(2, '0')}`;
      });

      chart.data.labels = labels;
      chart.data.datasets[0].data = concentrations;
      chart.update();
    }

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Concentration de Ritaline (mg)',
          data: [],
          borderColor: 'blue',
          backgroundColor: 'transparent',
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'mg dans le corps'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Heure'
            },
            ticks: {
              maxRotation: 90,
              minRotation: 60
            }
          }
        }
      }
    });

    // ✅ RÉCEPTION & PARSE FINAL
    window.addEventListener("message", event => {
      try {
        let data = event.data;
        console.log("Reçu :", data);

        // 1er parse
        if (typeof data === "string") {
          data = JSON.parse(data);
        }

        // 2e parse si nécessaire (parfois le premier parse donne encore une string)
        if (typeof data === "string") {
          data = JSON.parse(data);
        }

        console.log("Après parsing :", data);

        if (Array.isArray(data)) {
          createChart(data);
        } else {
          console.error("Format inattendu :", data);
        }

      } catch (e) {
        console.error("Erreur parsing double JSON :", e);
      }
    });
  </script>
</body>
</html>
